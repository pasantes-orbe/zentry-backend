'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  up: async (queryInterface, Sequelize) => {
    // Convertir users.id en IDENTITY en Postgres (robusto y sin depender de secuencia externa)
    // Nota: algunos engines requieren DROP DEFAULT antes de ADD IDENTITY.
    await queryInterface.sequelize.query(`
      DO $$
      BEGIN
        -- Si la columna ya es identity, no hacer nada
        IF EXISTS (
          SELECT 1
          FROM information_schema.columns c
          JOIN information_schema.columns col ON col.table_name = c.table_name AND col.column_name = c.column_name
          WHERE c.table_schema = 'public' AND c.table_name = 'users' AND c.column_name = 'id'
        ) THEN
          -- Intentar convertir a identity de forma idempotente
          BEGIN
            ALTER TABLE public.users
              ALTER COLUMN id DROP DEFAULT;
          EXCEPTION WHEN others THEN
            -- ignorar si no hay default
          END;

          BEGIN
            ALTER TABLE public.users
              ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
          EXCEPTION WHEN others THEN
            -- si ya es identity, continuar
          END;
        END IF;
      END$$;
    `);
  },

  down: async (queryInterface, Sequelize) => {
    // Revertir IDENTITY si fuera necesario (no elimina datos)
    await queryInterface.sequelize.query(`
      DO $$
      BEGIN
        BEGIN
          ALTER TABLE public.users
            ALTER COLUMN id DROP IDENTITY IF EXISTS;
        EXCEPTION WHEN others THEN
          -- ignorar
        END;
      END$$;
    `);
  }
};
